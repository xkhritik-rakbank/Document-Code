SELECT e.Prospectid AS 'Prospect Reference', 
       e.WiName AS 'WI Number', 
       CASE WHEN e.MiddleName IS NULL THEN CONCAT(e.FirstName, ' ', e.LastName) 
            ELSE CONCAT(e.FirstName, ' ', e.MiddleName, ' ', e.LastName) END AS 'Customer Name', 
       e.MobileNo AS 'Mobile Number', 
       e.emailid AS 'Email ID', 
       e.CustomerDeclaredMonthlyIncome AS 'Income declared by Customer', 
       e.FinalTAI AS 'Final Income from Dectech', 
       s.NetSalary1_AMD AS 'Income at Underwriting: Net sal 1', 
       s.NetSalary2_AMD AS 'Income at Underwriting: Net sal 2', 
       s.NetSalary3_AMD AS 'Income at Underwriting: Net sal 3', 
       CONCAT(s.Net_Salary_Month_1, ', ', s.Net_Salary_Month_2, ', ', s.Net_Salary_Month_3) AS 'Net salary amended by Exceptions User', 
       (SELECT DISTINCT STUFF((SELECT ', '+ Deviation_Description FROM NG_DPL_GR_DEVIATION_DESCRIPTIO WITH(NOLOCK) WHERE wi_name = e.WiName FOR XML PATH ('')),1,1,'')) AS 'Dectech Deviations', 
       REPLACE(REPLACE(REPLACE(e.Non_STP_reason,'~',', ','"}',''),'{"Reasons":"','')) AS 'Non STP Reason', 
       e.ProspectCreationDate AS 'Application Date', 
       e.Agent_Code AS 'Agent Source Code', 
       d.username AS 'Decision taken by', 
       d.Decision_Date_Time AS 'Decision Date Time', 
       e.ECRN AS 'ECRN', 
       e.CIF AS 'CIF', 
       e.Dec_rejectReason AS 'Decline Reason'
FROM NG_DPL_EXTTABLE e WITH (NOLOCK)
INNER JOIN NG_DPL_IncomeExpense s WITH (NOLOCK) ON e.WiName = s.Wi_Name
LEFT JOIN NG_DPL_GR_DECISION_HISTORY d WITH (NOLOCK) ON e.WiName = d.wi_name AND d.workstep = 'Exception'
WHERE CAST(e.entryat as date) BETWEEN 2024-09-01 AND DATEADD(DAY, 1, 2024-09-17)
GROUP BY e.Prospectid, e.WiName, CASE WHEN e.MiddleName IS NULL THEN CONCAT(e.FirstName, '',e.LastName) ELSE CONCAT(e.FirstName,'',e.MiddleName,'',e.LastName) END,
         e.MobileNo, e.emailid, e.CustomerDeclaredMonthlyIncome, 
         e.FinalTAI,s.NetSalary1_AMD,s.NetSalary2_AMD,s.NetSalary3_AMD,
         CONCAT(s.Net_Salary_Month_1,' , ',s.Net_Salary_Month_2,' , ',s.Net_Salary_Month_3),
         REPLACE(REPLACE(REPLACE(e.Non_STP_reason,'~',' , ','"}',''),'{"Reasons":"','')),
         ProspectCreationDate,e.Agent_Code,d.username,d.Decision_Date_Time,e.ECRN,e.CIF,e.Dec_rejectReason
ORDER BY WiNumber DESC;